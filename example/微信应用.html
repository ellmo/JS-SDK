<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
  </head>
  <body>
    <div>
      <button id='bt' onclick="init()" style="margin:50px auto; width:200px; height: 50px; display: block">connect</button>
    </div>
    <script src='../xsdk.js'></script>
    <script>
      var XLINKAPPID = '2e07d2ae97c47e00'//云智易微信应用appID ,非微信appID
      var APIROOT = 'http://139.196.164.250:8081'
      var user_id = ''
      var devices = []

      // function _getSearchCode () {
      //   var search = location.search
      //   var searchs = {}, strs
      //   if (search.indexOf('?') != -1) {
      //     search = search.substr(1)
      //     strs = search.split('&')
      //     for (var i = 0; i < strs.length; i++) {
      //       searchs[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
      //     }
      //   }
      //
      //   return searchs['code']
      // }
      //
      // function $ajax (method, url, callback) {
      //   xmlHttp = new XMLHttpRequest()
      //   xmlHttp.onreadystatechange = function () {
      //     if(xmlHttp.readyState === 4) {
      //       if(xmlHttp.status === 200) {
      //         callback(xmlHttp.responseText)
      //       }
      //     }
      //   }
      //
      //   xmlHttp.open(method, url, true)
      //   xmlHttp.send()
      // }
      //
      // var code = _getSearchCode()
      //
      // var openIdUrl = APIROOT + '/v2/wechat_gateway/' + XLINKAPPID + '/get_open_id?code=' + code
      // $ajax('GET', openIdUrl, function (response) {
      //   resObj = JSON.parse(response)
      //   user_id = resObj['user_id']
      //   document.getElementById('bt').disabled = false
      //   var devicesUrl = APIROOT + '/v2/wechat_gateway/' + XLINKAPPID + '/wx_device_list?access_token=XLINKUserAccessToken&open_id=' + resObj.open_id
      //   $ajax('GET', devicesUrl, function (response) {
      //     resObj = JSON.parse(response)
      //     resObj.devices.forEach(function (item) {
      //       var device = {
      //         deviceid: item.device_id,
      //         user_id: user_id,
      //         token: user_id
      //       }
      //       devices.push(device)
      //     })
      //   })
      // })

      var feignDevices = [{  // 测试数据
        deviceid: '1725038851',
        userid: '1153087813',
        token: '1153087813'
      },{
        deviceid: '1725034861',
        userid: '1153087813',
        token: '1153087813'
      }]

      function init () {
        var wc = new XSDK('websocket', {
            type: 'remote',
            host: 'http://42.121.122.23:23775',
            userid: '1153087813'
        })

        wc.on('ready', function () {
          wc.emit('adddevices', feignDevices)
        }).on('statuschange', function (status) {
          console.log('sdk statuschange status = ' + status)
        }).on('devicesready', function (devices) {
          devices.forEach(function (device) {
            device.emit('connect')
            device.on('connect', function () { // connect事件触发表示当前设备实例连接上了云智易服务器。
            })
            .on('data', function (data) {
              console.log(data)
            })
            .on('disconnect', function (data) {
              console.log(data)
            })
            .on('statuschange', function (status) { // status=1 表示设备在线，status=0表示设备离线
              if (status === 1) { // 设备在线，可以发动数据控制设备
                device.emit('senddata', 'QWER')
              }
            })
          })
        })
      }
    </script>
  </body>
</html>
